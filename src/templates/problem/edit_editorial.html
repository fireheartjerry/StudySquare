{% extends "layout.html" %}

{% block title %}Edit Editorial for {{ data["name"] }}{% endblock %}
{% block active %}Practice{% endblock %}

{% block preload %}
<link rel="preload" href="/api/problem?id={{ request.path.split('/')[2] }}" as="fetch" crossorigin="anonymous">
{% endblock %}

{% block main %}
<h1>Edit Editorial for {{ data["name"] }}</h1>
<form method="POST" id="editorialForm">
    <input type="hidden" id="md_inp" name="editorial_md">
    <input type="hidden" id="html_inp" name="editorial_html">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
</form>
<div class="button-box col-lg-12" style="margin-top: 15px;">
    <button class="btn btn-secondary fw-bold" id="open">Open Markdown Editor</button>
    <input type="submit" class="btn btn-primary fw-bold" id="submit" style="margin-left: 5px; font-weight: bold;" form="editorialForm" value="Submit"/>
</div>
<h4 style="margin-top: 15px;"><u>Raw Markdown Content</u></h4>
<pre><code id="rawMD"></code></pre>
<h4 style="margin-top: 15px;"><u>Resulting HTML</u></h4>
<div id="resultHTML"></div>
{% endblock %}

{% block script %}
<script>
    const problemId = "{{ request.path.split('/')[2] }}";
    const md_raw = document.querySelector("#rawMD");
    const res_html = document.querySelector("#resultHTML");
    var opened = false;
    !async function() {
        const md_data = await fetch("/api/publicproblem?id=" + problemId).then(b => b.text())
        .then(b => JSON.parse(b)).then(b => {
            if (b['status'] !== "success") {
                console.log(`API fail: status: ${b["status"]}, message: ${b["message"]}`);
                return;
            } return b["data"]["editorial_md"];
        }).catch(e => { console.error(e); });
        const html_data = await fetch("/api/publicproblem?id=" + problemId).then(b => b.text())
        .then(b => JSON.parse(b)).then(b => {
            if (b['status'] !== "success") {
                console.log(`API fail: status: ${b["status"]}, message: ${b["message"]}`);
                return;
            } return b["data"]["editorial_html"];
        }).catch(e => { console.error(e); });
        if (md_data === "") {
            md_raw.innerText = "Raw markdown goes here...";
            res_html.innerHTML = "<p>...and rendered <b>HTML</b> goes <i>here</i>.</p";
        } else {
            md_raw.innerText = md_data;
            res_html.innerHTML = html_data;
            document.querySelector("#md_inp").value = md_data;
            document.querySelector("#html_inp").value = html_data;
            renderLatex();
        } document.querySelector("#open").addEventListener("click", function() {
            let inp_data = md_data;
            if (opened) inp_data = md_raw.innerText;
            md2html_interactive(inp_data).then((result) => {
                md_raw.innerText = result.md;
                res_html.innerHTML = result.html;
                renderLatex();
                document.querySelector("#md_inp").value = result.md;
                document.querySelector("#html_inp").value = result.html
                if (!opened) opened = true;
            }).catch((e) => { console.error(e); });
        });
    } ();
</script>
{% endblock %}
