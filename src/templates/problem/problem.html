{% extends "layout.html" %}

{% block title %}{{ data["name"] }}{% endblock %}
{% block active %}Practice{% endblock %}

{% block preload %}
    <link rel="preload" href="/api/{% if data['private'] %}private{% else %}public{% endif %}problem?id={{ request.path.split('/')[2] }}" as="fetch" crossorigin="anonymous">
{% endblock %}

{% block main %}
<h1>
    {% if data["solved"] %}
        <img class="svg-green icon" src="/assets/images/check.svg"
             alt="Solved" onerror="this.src='/assets/images/check.png'">
    {% endif %}
    {{ data["name"] }}
    {% if data["private"] %}<a href="/organization/{{ data["private_org"] }}" class="badge bg-secondary rounded-pill growable mx-1" title='This problem is private to the organization "{{ private_org_name }}".' data-toggle="tooltip">Private</a>{% endif %}
</h1>
{% if timed_mode %}
    <div id="time-taken">
        <input id="start" name="controls" type="radio" class="hidden">
        <input id="stop" name="controls" type="radio" class="hidden">
        <input id="reset" name="controls" type="radio" class="hidden">
        
            <div class="problem-timer">
                <span>Time Passed: <b style="font-family: monospace;">00:00:00.00</b></span>
            </div>
        
        <div class="problem-timer-controls">
            <label for="start">
                <i class="fa fa-play"></i>
            </label>
            <label for="stop">
                <i class="fa fa-pause"></i>
            </label>
            <label for="reset">
                <i class="fa fa-refresh"></i>
            </label>
        </div>
    </div>
{% endif %}
<hr>
{% if check_perm(["ADMIN", "SUPERADMIN", "PROBLEM_MANAGER", "CONTENT_MANAGER"]) %}
    <div id="confirm" style="display: none;">
        <form method="post" style="margin-bottom: 1rem;" action="">
            <input class="btn btn-danger" type="submit" value="">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        </form>
    </div>
{% endif %}
<div class="flex">
    <div style="flex: 3; padding: 4px; word-break: break-word; min-width: 0px;">
        <div id="problem-description"></div>
        <div id="hint-container">
            <btn class="btn btn-secondary fw-bold" id="togglehint">
                Show/Hide Hints
            </btn>
            <div id="hint" class="card hidden"></div>
        </div> <br>
        <a id="rankinglink" href="" class="btn btn-secondary fw-bold" style="margin-bottom: 10px; font-size: 15px; padding: 8px;">Go to problem ranking</a>
        <details>
            <summary class="btn btn-secondary fw-bold" style="padding: 8px; font-size: 15px;">Show/Hide Problem Tags</summary> <br><br>
            <span><b>Problem Tags:</b></span>
            {% if tags %}
                {% for tag in tags %}
                    <span class="badge bg-primary rounded-pill" style="padding: 6px; text-align: center; margin-left: 3px; margin-bottom: 5px;">{{ tag }}</span>
                {% endfor %}
            {% else %}
                <span class="badge bg-secondary rounded-pill" style="padding: 6px; text-align: center; margin-left: 3px; margin-bottom: 5px;">No tags</span>
            {% endif %}
        </details>
        <hr>
        Want to contribute problems and receive full credit? Click <a href="https://forms.gle/c1BXUn197i4wtrCy9"><b>here</b></a> to add your problem!
        <br> <b style="color: red;">Please report any issues to us in our <a href="https://discord.com/invite/zUdmCWPT3f">Discord server</a></b>
        {% if can_prev %}
            <br>
            <a class="btn btn-outline-primary" data-toggle="tooltip" data-placement="bottom" title="This problem is part of a contest, click this button to go to the previous corresponding problem." style="margin-top: 10px; margin-right: 5px;" href="{{ prev }}">Go to previous contest problem (SHIFT + Left Arrow)</a>
        {% endif %}
        {% if can_next %}
            {% if not can_prev %}
                <br>
            {% endif %}
            <a class="btn btn-outline-primary" data-toggle="tooltip" data-placement="bottom" title="This problem is part of a contest, click this button to go to the next corresponding problem." style="margin-top: 10px;" href="{{ nxt }}">Go to next contest problem (SHIFT + Right Arrow)</a>
        {% endif %}

    </div>
    <div style="flex: 1; padding: 4px;">
        <form autocomplete="off" method="post" style="margin-bottom: 0.5rem;">
            <input class="form-control"
                   name="answer"
                   id="answer"
                   placeholder="Answer"
                   style="margin-bottom: 0.5rem;"
                   required>
            <input {% if not team_account %}class="btn btn-primary problem-submit-button growable" type="submit" id="submit" value="Submit"{% endif %} {% if team_account %}class="btn btn-primary" style="cursor: not-allowed;" title="You cannot submit as you are using a team account" data-toggle="tooltip" value="Cannot Submit"{% endif %}>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        </form>

        <div>
            <b>Category:</b> <a href="/problems?category={{ data["category"] }}">{{ data["category"] }}</a><br>
            <b>Points:</b> {{ data["point_value"] }}<br>
            <b><a href="/problems">Back to practice</a></b>
            {% if session.user_id %}
                {% if check_perm(["ADMIN", "SUPERADMIN", "CONTENT_MANAGER"]) %}
                    <br><a href="/admin/submissions?problem_id={{ request.path.split('/')[2] }}">All submissions</a>
                    <br><a href="/admin/submissions?username={{ username }}&problem_id={{ request.path.split('/')[2] }}">My submissions</a>
                {% else %}
                    <br><a href="/submissions?problem_id={{ request.path.split('/')[2] }}">All submissions</a>
                    <br><a href="/submissions?username={{ username }}&problem_id={{ request.path.split('/')[2] }}">My submissions</a>
                {% endif %}
                {% if data["editorial"] %}
                    <br><a href="{{ request.path }}/editorial">View editorial</a>
                {% endif %}
                {% if check_perm(["ADMIN", "SUPERADMIN", "PROBLEM_MANAGER", "CONTENT_MANAGER"]) %}
                    <br><a href="{{ request.path }}/editeditorial">Create/edit editorial</a>
                    <br><a href="{{ request.path }}/edit">Edit problem</a>
                    <br><a href="{{ request.path }}/download">Download problem</a>
                    <br><a href="#" class="btn-delete fw-bold text-danger">Delete problem</a>
                    {% if data["draft"] %}
                        <br><a href="#" class="btn-publish fw-bold">Publish draft</a>
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    const problemId = "{{ request.path.split('/')[2] }}";
    document.addEventListener('DOMContentLoaded', function() {
        let problemId = "{{ request.path.split('/')[2] }}";

        let rankingLink = document.getElementById('rankinglink');

        rankingLink.href = `/problemranking/${problemId}`;
    });
    const hints = document.getElementById("hint");
    fetch("/api/{% if data['private'] %}private{% else %}public{% endif %}problem?id=" + problemId).then(b => b.text())
            .then(b => JSON.parse(b)).then(b => {
        if (b["status"] !== "success") {
            console.log(`API fail: status: ${b["status"]}, message: ${b["message"]}`);
            return;
        } document.getElementById("problem-description").innerHTML = b["data"]["description_html"];
        renderLatex();
        if (b["data"]["hints_html"] != "") {
            document.getElementById("hint-container").style.display = "block";
            hints.innerHTML = b["data"]["hints_html"];
            renderLatex();
        }
    });
    document.getElementById("togglehint").addEventListener("click", function() {
        hints.classList.toggle("hidden");
    });

    {% if timed_mode %}
        // Select necessary elements
        const startRadio = document.getElementById('start');
        const stopRadio = document.getElementById('stop');
        const resetRadio = document.getElementById('reset');
        const timerDisplay = document.querySelector('#time-taken .problem-timer span');

        let startTime = 0; // Variable to store start time in milliseconds
        let timerInterval; // Variable to hold the setInterval reference

        // Function to format time in HH:mm:ss.SS format
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const millisecondsFormatted = Math.floor((milliseconds % 1000) / 10);

            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${millisecondsFormatted.toString().padStart(2, '0')}`;
        }

        // Event listener for start button
        let current_time_milliseconds = 0;
        startRadio.addEventListener('change', function() {
            if (startRadio.checked) {
                timerInterval = setInterval(function() {
                    current_time_milliseconds += 10;
                    timerDisplay.innerHTML = `<span>Time Passed: <b style="font-family: monospace;">${formatTime(current_time_milliseconds)}</b></span>`;
                }, 10);
            }
        });

        // Event listener for stop button
        stopRadio.addEventListener('change', function() {
            if (stopRadio.checked) {
                // Pause the timer
                clearInterval(timerInterval);
            }
        });

        // Event listener for reset button
        resetRadio.addEventListener('change', function() {
            if (resetRadio.checked) {
                // Reset the timer
                clearInterval(timerInterval);
                current_time_milliseconds = 0;
                timerDisplay.innerHTML = '<span>Time Passed: <b style="font-family: monospace;">00:00:00.00</b></span>';
            }
        });
    {% endif %}

    {% if streak_added or streak_broken or first_streak %}
        // Display a custom overlay for a streak increase or break
        const streakOverlay = document.createElement('div');
        streakOverlay.classList.add('streak-overlay');

        const streak_message = document.createElement('div');
        streak_message.classList.add('streak-message');

        let title, message;
        {% if streak_added %}
            title = "Streak Increased!";
            message = `You have increased your streak! It is now at {{ new_streak }}. {% if streak_bonus > 0 %}Additionally, you got a streak bonus of {{ streak_bonus }} points{% else %}Keep submitting to get a streak bonus{% endif %}!`;
        {% elif streak_broken %}
            title = "Streak Broken!";
            message = "You have broken your streak! Your streak has been reset to 1.";
        {% elif first_streak %}
            title = "You Have Started a Streak!";
            message = "You have restarted a new streak! Submit every day to maintain this.";
        {% endif %}

        streak_message.innerHTML = `
            <h1 class="display-4 fw-bold">${title}</h1>
            <p class="lead">${message}</p>
            <hr class="my-4">
            <span>Streaks are a measure of your consistency in solving problems. Once you reach a certain streak, you will get bonus points for problems (bonus points are not counted in the weekly leaderboard). Keep it up!</span><br><br>
            <p class="lead">
            <a class="btn btn-outline-secondary close" href="#" role="button">Close &times;</a>
            </p>
        `;

        streakOverlay.appendChild(streak_message);
        document.body.appendChild(streakOverlay);
        streak_message.querySelector('.close').addEventListener('click', () => {
            document.body.removeChild(streakOverlay);
        });
    {% endif %}

    document.addEventListener('keydown', function(event) {
        {% if can_next %}
            if (event.shiftKey && event.key === 'ArrowRight') {
                window.location.href = "{{ nxt }}";
            }
        {% endif %}
        {% if can_prev %}
            if (event.shiftKey && event.key === 'ArrowLeft') {
                window.location.href = "{{ prev }}";
            }
        {% endif %}
    });

</script>
{% if check_perm(["ADMIN", "SUPERADMIN", "PROBLEM_MANAGER", "CONTENT_MANAGER"]) %}
<script>
    document.querySelector(".btn-delete").addEventListener("click", function () {
        document.getElementById("confirm").style.display = "";
        document.querySelector("#confirm form")
                .setAttribute("action", window.location.pathname + "/delete");
        document.querySelector("#confirm form .btn")
                .setAttribute("value", "Are you sure you want to delete this problem? " +
                                       "Click here to confirm.");
        window.scrollTo(0, 0);
    });
</script>
{% endif %}
{% if data["draft"] %}
<script>
    document.querySelector(".btn-publish").addEventListener("click", function () {
        document.getElementById("confirm").style.display = "";
        document.querySelector("#confirm form")
                .setAttribute("action", window.location.pathname + "/publish");
        document.querySelector("#confirm form .btn")
                .setAttribute("value", "Are you sure you want to publish this problem? " +
                                       "Click here to confirm.");
        window.scrollTo(0, 0);
    });
</script>
{% endif %}
{% endblock %}
